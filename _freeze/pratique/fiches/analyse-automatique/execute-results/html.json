{
  "hash": "ee108432dd6a395fee268c8fe41f44b1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Analyse automatique des métadonnées pour la protection des données tabulées\n---\n\nL'analyse de la demande peut être faite \"à la main\", c'est-à-dire en suivant toutes les étapes présentées dans la partie \"Analyser la demande\" du [cours](../../theorie/supports/methodes-suppressives.qmd). Cette [fiche](analyse-demande.qmd) présente plusieurs exemples de demandes et leur analyse.\n\nOn peut aussi utiliser la fonction `analyse_metadata()` qui permet une analyse automatique de la demande à partir de métadonnées bien formatées.\n\n# Initialisation\n\nInstallation du package rtauargus.\n\n::: {.cell}\n\n```{.r .cell-code}\nremotes::install_github(\n  'InseeFrLab/rtauargus',\n  dependencies = TRUE,\n  build_vignettes = FALSE,\n  upgrade = 'never',\n  ref = \"v-1.2.999-dev\" # version dev avec la fonction d'analyse automatique\n)\n```\n:::\n\n\nImport des packages.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rtauargus)\n```\n:::\n\n\n# Métadonnées\n\n\n::: {.cell as-is='true'}\n::: {.cell-output-display}\n\n\n|Tab |Var_reponse |expl_var1 |expl_var2 |\n|:---|:-----------|:---------|:---------|\n|T1  |ca_pizzas   |Nuts2     |TREFF     |\n|T2  |ca_pizzas   |Nuts3     |TREFF     |\n|T3  |ca_pizzas   |A10       |Nuts2     |\n|T4  |ca_pizzas   |A10       |Nuts3     |\n|T5  |ca_pizzas   |A21       |Nuts2     |\n|T6  |ca_pizzas   |A21       |Nuts3     |\n|T7  |ca_pizzas   |A88       |Nuts2     |\n|T8  |ca_pizzas   |A88       |Nuts3     |\n|T9  |ca_batavia  |A10       |TREFF     |\n|T10 |ca_batavia  |A10       |CJ        |\n|T11 |ca_batavia  |A21       |TREFF     |\n|T12 |ca_batavia  |A21       |CJ        |\n|T13 |ca_batavia  |A88       |TREFF     |\n|T14 |ca_batavia  |A88       |CJ        |\n|T15 |ca_mache    |A10       |TREFF     |\n|T16 |ca_mache    |A10       |CJ        |\n|T17 |ca_mache    |A21       |TREFF     |\n|T18 |ca_mache    |A21       |CJ        |\n|T19 |ca_mache    |A88       |TREFF     |\n|T20 |ca_mache    |A88       |CJ        |\n|T21 |ca_salades  |A10       |TREFF     |\n|T22 |ca_salades  |A10       |CJ        |\n|T23 |ca_salades  |A21       |TREFF     |\n|T24 |ca_salades  |A21       |CJ        |\n|T25 |ca_salades  |A88       |TREFF     |\n|T26 |ca_salades  |A88       |CJ        |\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChamp de la population : entreprises françaises.\nInformations complémentaires : il n'y a que deux types de salades les batavias et la mâche.\n```\n\n\n:::\n:::\n\n\n# Utilisation de la fonction `analyse_metadata()`\n\nLes métadonnées doivent respecter un format spécifique. Une ligne représente un tableau et pour chaque tableau il faut préciser :\n\n- `table_name` : le nom du tableau ;\n- `field` : le champ (souvent, zone géographique, population étudiée, millésime) ;\n- `hrc_field` : s'il existe ou non un lien hiérarchique entre ce champ et un autre champ. S'il n'y a pas de lien hiérarchique cette case vaut `NA`. Si au contraire, un lien hiérarchique existe, il faut donner un nom à ce lien et réécrire ce même nom dans les autres tableaux ;\n- `indicator` : le nom de l'indicateur du tableau. Il s'agit du nom de la variable de ce qui est compté dans chaque cellule du tableau. Par exemple, si mon tableau présente le chiffre d'affaire des entreprises ma variable sera sans doute \"CA\". Le mieux est de bien utiliser le nom de la variable tel que décrit dans les données ;\n- `hrc_indicator` : s'il existe ou non un lien hiérarchique entre cet indicateur et un autre indicateur. S'il n'y a pas de lien hiérarchique cette case vaut `NA`. Si au contraire, un lien hiérarchique existe, il faut donner un nom à ce lien et réécrire ce même nom dans les autres tableaux ;\n- `spanning_1` : le nom de la première variable de croisement. On ajoute une colonne par variable de croisement en suivant le nommage : `spanning_1`, `spanning_2`, `spanning_3`, etc ;\n- `hrc_spanning_1` : s'il existe ou non un lien hiérarchique entre cette variable de croisement et une autre variable de croisement. S'il n'y a pas de lien hiérarchique cette case vaut `NA`. Si au contraire, un lien hiérarchique existe, il faut donner un nom à ce lien et réécrire ce même nom dans les autres tableaux. On ajoute une colonne par variable de croisement en suivant le nommage : `hrc_spanning_1`, `hrc_spanning_2`, `hrc_spanning_3`, etc. N.B. il faut autant de colonnes `spanning_X` que de colonnes `hrc_spanning_X`.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-a65f5b4a7b7479fad36a\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-a65f5b4a7b7479fad36a\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\"],[\"T1\",\"T2\",\"T3\",\"T4\",\"T5\",\"T6\",\"T7\",\"T8\",\"T9\",\"T10\",\"T11\",\"T12\",\"T13\",\"T14\",\"T15\",\"T16\",\"T17\",\"T18\",\"T19\",\"T20\",\"T21\",\"T22\",\"T23\",\"T24\",\"T25\",\"T26\"],[\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_pizzas\",\"ca_batavia\",\"ca_batavia\",\"ca_batavia\",\"ca_batavia\",\"ca_batavia\",\"ca_batavia\",\"ca_mache\",\"ca_mache\",\"ca_mache\",\"ca_mache\",\"ca_mache\",\"ca_mache\",\"ca_salades\",\"ca_salades\",\"ca_salades\",\"ca_salades\",\"ca_salades\",\"ca_salades\"],[null,null,null,null,null,null,null,null,\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\",\"hrc_salades\"],[\"Nuts2\",\"Nuts3\",\"A10\",\"A10\",\"A21\",\"A21\",\"A88\",\"A88\",\"A10\",\"A10\",\"A21\",\"A21\",\"A88\",\"A88\",\"A10\",\"A10\",\"A21\",\"A21\",\"A88\",\"A88\",\"A10\",\"A10\",\"A21\",\"A21\",\"A88\",\"A88\"],[\"hrc_nuts\",\"hrc_nuts\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\",\"hrc_naf\"],[\"TREFF\",\"TREFF\",\"Nuts2\",\"Nuts3\",\"Nuts2\",\"Nuts3\",\"Nuts2\",\"Nuts3\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\",\"TREFF\",\"CJ\"],[null,null,\"hrc_nuts\",\"hrc_nuts\",\"hrc_nuts\",\"hrc_nuts\",\"hrc_nuts\",\"hrc_nuts\",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>table_name<\\/th>\\n      <th>field<\\/th>\\n      <th>hrc_field<\\/th>\\n      <th>indicator<\\/th>\\n      <th>hrc_indicator<\\/th>\\n      <th>spanning_1<\\/th>\\n      <th>hrc_spanning_1<\\/th>\\n      <th>spanning_2<\\/th>\\n      <th>hrc_spanning_2<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"table_name\",\"targets\":1},{\"name\":\"field\",\"targets\":2},{\"name\":\"hrc_field\",\"targets\":3},{\"name\":\"indicator\",\"targets\":4},{\"name\":\"hrc_indicator\",\"targets\":5},{\"name\":\"spanning_1\",\"targets\":6},{\"name\":\"hrc_spanning_1\",\"targets\":7},{\"name\":\"spanning_2\",\"targets\":8},{\"name\":\"hrc_spanning_2\",\"targets\":9}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nOn peut ensuite faire appel à la fonction `analyse_metadata()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncluster_demande1 <- analyse_metadata(demande1, verbose = FALSE)\n```\n:::\n\n\nN.B. si l'on souhaite avoir plus de détails sur les étapes de l'analyse on indique `verbose = TRUE`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nDT::datatable(cluster_demande1)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-1c950f6a03256641d7ff\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1c950f6a03256641d7ff\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\"],[\"ent_france.hrc_salades\",\"ent_france.hrc_salades\",\"ent_france.ca_pizzas\",\"ent_france.ca_pizzas\"],[\"T10.T12.T14.T16.T18.T20.T22.T24.T26\",\"T11.T13.T15.T17.T19.T21.T23.T25.T9\",\"T1.T2\",\"T3.T4.T5.T6.T7.T8\"],[\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\"],[\"SALADES\",\"SALADES\",\"ca_pizzas\",\"ca_pizzas\"],[\"HRC_NAF\",\"HRC_NAF\",\"HRC_NUTS\",\"HRC_NAF\"],[\"CJ\",\"TREFF\",\"TREFF\",\"HRC_NUTS\"],[\"HRC_SALADES^h\",\"HRC_SALADES^h\",null,null],[\"hrc_naf\",\"hrc_naf\",\"hrc_nuts\",\"hrc_naf\"],[null,null,null,\"hrc_nuts\"],[\"hrc_salades\",\"hrc_salades\",null,null]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>cluster<\\/th>\\n      <th>table_name<\\/th>\\n      <th>field<\\/th>\\n      <th>indicator<\\/th>\\n      <th>spanning_1<\\/th>\\n      <th>spanning_2<\\/th>\\n      <th>spanning_3<\\/th>\\n      <th>hrc_spanning_1<\\/th>\\n      <th>hrc_spanning_2<\\/th>\\n      <th>hrc_spanning_3<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"cluster\",\"targets\":1},{\"name\":\"table_name\",\"targets\":2},{\"name\":\"field\",\"targets\":3},{\"name\":\"indicator\",\"targets\":4},{\"name\":\"spanning_1\",\"targets\":5},{\"name\":\"spanning_2\",\"targets\":6},{\"name\":\"spanning_3\",\"targets\":7},{\"name\":\"hrc_spanning_1\",\"targets\":8},{\"name\":\"hrc_spanning_2\",\"targets\":9},{\"name\":\"hrc_spanning_3\",\"targets\":10}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nFinalement, pour protéger les 26 tableaux qui seront publiés il suffit de protéger 4 tableaux. Les tableaux sont liés deux à deux, autrement dit il y a deux clusters (*ent_france.hrc_salades* et *ent_france.ca_pizzas*). Il faudra donc faire appel deux fois à `rtauargus::tab_multi_manager()`.\n\n## Avec des hiérarchies non-emboîtées\n\nA présent on ajoute d'autres sous-totaux à la demande. Pour chaque tableau concernant l'activité, on souhaite disposer des deux sous-totaux supplémentaires:\n\n- D_To_H : D+E+F+G+H (code NAF: A21)\n- C14_To_C19: 14+15+16+18+19 (code NAF: A88)\n\nPour prendre en compte les hiérarchies non-emboîtées, on duplique les tableaux concernés et on suffixe par 'alt' ces variables.\nOn rajoute ensuite les tableaux dupliqués à 'cluster_demande1' pour obtenir la liste des tableaux à protéger.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Dupliquer les tableaux concernés\ntab_dupliquer <- cluster_demande1[c(1, 2, 4), , drop = FALSE]\n\n# Renommer les tableaux (_bis) et les hiérarchies correspondantes (_alt)\ntab_dupliquer[1:3, c(\"table_name\", \"hrc_spanning_1\")] <- data.frame(\n  table_name = c(\"T10.T12.T14.T16.T18.T20.T22.T24.T26_bis\",\n                 \"T11.T13.T15.T17.T19.T21.T23.T25.T9_bis\",\n                 \"T3.T4.T5.T6.T7.T8_bis\"),\n  hrc_spanning_1 = c(\"hrc_naf_alt\", \"hrc_naf_alt\", \"hrc_naf_alt\")\n)\n\n# Liste des tableaux à protéger\ncluster_demande1bis <- rbind(cluster_demande1, tab_dupliquer)\n\n# Visualisation\nDT::datatable(cluster_demande1bis)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-ce0111f46ab43ba288fe\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-ce0111f46ab43ba288fe\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],[\"ent_france.hrc_salades\",\"ent_france.hrc_salades\",\"ent_france.ca_pizzas\",\"ent_france.ca_pizzas\",\"ent_france.hrc_salades\",\"ent_france.hrc_salades\",\"ent_france.ca_pizzas\"],[\"T10.T12.T14.T16.T18.T20.T22.T24.T26\",\"T11.T13.T15.T17.T19.T21.T23.T25.T9\",\"T1.T2\",\"T3.T4.T5.T6.T7.T8\",\"T10.T12.T14.T16.T18.T20.T22.T24.T26_bis\",\"T11.T13.T15.T17.T19.T21.T23.T25.T9_bis\",\"T3.T4.T5.T6.T7.T8_bis\"],[\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\",\"ent_france\"],[\"SALADES\",\"SALADES\",\"ca_pizzas\",\"ca_pizzas\",\"SALADES\",\"SALADES\",\"ca_pizzas\"],[\"HRC_NAF\",\"HRC_NAF\",\"HRC_NUTS\",\"HRC_NAF\",\"HRC_NAF\",\"HRC_NAF\",\"HRC_NAF\"],[\"CJ\",\"TREFF\",\"TREFF\",\"HRC_NUTS\",\"CJ\",\"TREFF\",\"HRC_NUTS\"],[\"HRC_SALADES^h\",\"HRC_SALADES^h\",null,null,\"HRC_SALADES^h\",\"HRC_SALADES^h\",null],[\"hrc_naf\",\"hrc_naf\",\"hrc_nuts\",\"hrc_naf\",\"hrc_naf_alt\",\"hrc_naf_alt\",\"hrc_naf_alt\"],[null,null,null,\"hrc_nuts\",null,null,\"hrc_nuts\"],[\"hrc_salades\",\"hrc_salades\",null,null,\"hrc_salades\",\"hrc_salades\",null]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>cluster<\\/th>\\n      <th>table_name<\\/th>\\n      <th>field<\\/th>\\n      <th>indicator<\\/th>\\n      <th>spanning_1<\\/th>\\n      <th>spanning_2<\\/th>\\n      <th>spanning_3<\\/th>\\n      <th>hrc_spanning_1<\\/th>\\n      <th>hrc_spanning_2<\\/th>\\n      <th>hrc_spanning_3<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"cluster\",\"targets\":1},{\"name\":\"table_name\",\"targets\":2},{\"name\":\"field\",\"targets\":3},{\"name\":\"indicator\",\"targets\":4},{\"name\":\"spanning_1\",\"targets\":5},{\"name\":\"spanning_2\",\"targets\":6},{\"name\":\"spanning_3\",\"targets\":7},{\"name\":\"hrc_spanning_1\",\"targets\":8},{\"name\":\"hrc_spanning_2\",\"targets\":9},{\"name\":\"hrc_spanning_3\",\"targets\":10}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}